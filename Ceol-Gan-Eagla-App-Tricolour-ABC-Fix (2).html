<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ceol Gan Eagla — Tricolour Edition (ABCJS Fix)</title>
<meta name="theme-color" content="#1d7f3b">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
:root{--green:#1d7f3b;--ivory:#ffffff;--amber:#f4a321;--ink:#0e1a12;--muted:#5a6c60;--bg:#f7f8f7;--line:#e1e6e2;--card:#ffffff;--radius:20px;--shadow:0 10px 30px rgba(0,0,0,.10),0 1px 0 rgba(0,0,0,.04)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans;color:var(--ink);background:linear-gradient(180deg, rgba(29,127,59,.035), rgba(244,163,33,.035)),var(--bg)}
.tri-border{position:relative;border:1px solid var(--line);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow);overflow:hidden}
.tri-border::before{content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;background:linear-gradient(90deg,var(--green),var(--ivory),var(--amber));-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.header{position:sticky;top:0;z-index:100;background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.85)),var(--card);border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
.header .band{height:6px;background:linear-gradient(90deg,var(--green),var(--ivory),var(--amber));border-bottom:1px solid var(--line)}
.header .in{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
.flaglogo{width:36px;height:24px;border-radius:6px;overflow:hidden;border:1px solid var(--line);display:grid;grid-template-columns:repeat(3,1fr)}
.flaglogo i:nth-child(1){background:var(--green)}.flaglogo i:nth-child(2){background:var(--ivory)}.flaglogo i:nth-child(3){background:var(--amber)}
.title{display:flex;flex-direction:column;line-height:1.05}.title strong{font-size:18px}.title small{color:var(--muted)}
.page{max-width:1100px;margin:18px auto 96px;padding:0 16px}
.section{padding:18px}.section h1{margin:0 0 6px 0;font-size:28px}.section p{margin:0;color:var(--muted)}
.flag-cap{position:relative;padding-top:12px}.flag-cap::before{content:"";position:absolute;left:0;top:0;height:6px;width:100%;background:linear-gradient(90deg,var(--green),var(--ivory),var(--amber))}
.searchbar{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 1px 0 rgba(29,127,59,.08)}
.searchbar input{flex:1;border:0;outline:none;font-size:16px;background:transparent}
.filters{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px}@media(min-width:720px){.filters{grid-template-columns:1fr 1fr}}
.pills{display:flex;flex-wrap:wrap;gap:8px}
.pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(90deg, rgba(29,127,59,.09), rgba(255,255,255,.9), rgba(244,163,33,.09));color:#0e3b22;font-weight:800;cursor:pointer}
.pill[aria-pressed="true"]{background:linear-gradient(90deg,var(--green),var(--ivory),var(--amber));color:#0f130e;border-color:#0f5b2a}
.list{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.item{position:relative;padding:14px 14px 14px 16px;border-radius:14px;border:1px solid var(--line);background:#fff;display:grid;gap:6px;text-decoration:none;color:inherit}
.item::before{content:"";position:absolute;left:0;top:0;bottom:0;width:5px;background:linear-gradient(180deg,var(--green),var(--ivory),var(--amber));border-top-left-radius:14px;border-bottom-left-radius:14px}
.item:hover{border-color:#cfe1d6;background:#fbfffc}
.badges{display:flex;gap:6px;flex-wrap:wrap}.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
.badge.air{background:#e8f4ec;border-color:#cfe6d6;color:#125b2b}
.tuneHead{padding:16px;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg, rgba(244,163,33,.08), #fff),linear-gradient(180deg, rgba(29,127,59,.08), rgba(255,255,255,0));position:relative}
.tuneHead::after{content:"";position:absolute;inset:-1px;border-radius:16px;background:linear-gradient(90deg,var(--green),var(--ivory),var(--amber));z-index:-1;filter:blur(14px);opacity:.16}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer;background-image:linear-gradient(90deg, rgba(29,127,59,.08), rgba(255,255,255,.9), rgba(244,163,33,.08))}
.btn.play{color:#fff;border-color:#0f5b2a;background-image:linear-gradient(90deg,var(--green),#2aa257,var(--green))}
.btn.stop{background:#fff}
.btn.pdf{color:#2b2208;border-color:#c27f0b;background-image:linear-gradient(90deg,var(--amber),#ffd28e,var(--amber))}
.navbar{position:fixed;left:0;right:0;bottom:0;z-index:40;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:10px 12px;background:#0b100d;border-top:1px solid #000}
.navbtn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:14px;color:#e8f3ea;text-decoration:none;position:relative}
.navbtn svg{width:22px;height:22px;stroke:#d2e7d8}
.navbtn[aria-current="page"]{color:#0e1a12;background:linear-gradient(90deg,var(--green),var(--ivory),var(--amber))}
.navbtn[aria-current="page"] svg{stroke:#0f2416}
.toolhost{border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff;box-shadow:var(--shadow);background-image:linear-gradient(180deg, rgba(29,127,59,.04), rgba(244,163,33,.04))}
.note{padding:8px 10px;border-radius:10px;border:1px dashed var(--line);background:#fff8;margin-top:10px;font-size:13px;color:var(--muted)}
.footerNote{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}
.hidden{display:none}
/* ABCJS control styling (optional, harmless if not present) */
.abcjs-inline-midi{margin:8px 0 0 0;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
</style>
</head>
<body>
<header class="header">
  <div class="band" aria-hidden="true"></div>
  <div class="in">
    <a class="brand" href="#search">
      <span class="flaglogo" aria-hidden="true"><i></i><i></i><i></i></span>
      <span class="title"><strong>Ceol Gan Eagla</strong><small>Music Without Fear</small></span>
    </a>
  </div>
</header>

<main class="page">
  <section id="abcErr" class="tri-border section hidden" role="alert" style="background:#fff7f7;border-color:#ffd2d2">
    <strong>ABCJS failed to load.</strong> Your network might be blocking a CDN. The app will still open, but tune rendering & playback won’t work.
    <div class="note">Try reloading, or tell me and I’ll bundle ABCJS locally for you.</div>
  </section>

  <section id="page-search" class="tri-border section flag-cap" role="region" aria-label="Search & Browse">
    <h1>Search & Browse</h1>
    <p>Search tunes, songs, artists, regions…</p>
    <div class="searchbar" style="margin-top:12px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#294" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="q" placeholder="Search tunes, songs, artists, regions…">
    </div>
    <div class="filters">
      <div>
        <div style="font-weight:700;margin:10px 0 6px">Content Type</div>
        <div class="pills" id="scopePills">
          <button class="pill" data-scope="all" aria-pressed="true">All</button>
          <button class="pill" data-scope="tunes">Tunes</button>
          <button class="pill" data-scope="songs">Songs</button>
        </div>
      </div>
      <div>
        <div style="font-weight:700;margin:10px 0 6px">Tune Type</div>
        <div class="pills" id="kindPills">
          <button class="pill" data-kind="All Types" aria-pressed="true">All Types</button>
          <button class="pill" data-kind="Air">Air</button>
          <button class="pill" data-kind="Jig">Jig</button>
          <button class="pill" data-kind="Reel">Reel</button>
        </div>
      </div>
    </div>
    <div id="results" class="list"></div>
  </section>

  <section id="page-tune" class="tri-border section flag-cap hidden" role="region" aria-label="Tune detail">
    <div class="tuneHead">
      <h1 id="t-title">Tune</h1>
      <div id="t-badges" class="badges" style="margin-top:6px"></div>
      <p id="t-blurb" style="color:var(--muted)"></p>
      <div class="actions">
        <button id="t-play" class="btn play">▶ Play</button>
        <button id="t-stop" class="btn stop">■ Stop</button>
        <button id="t-print" class="btn pdf">Download PDF</button>
        <a class="btn" href="#search">← Back</a>
      </div>
      <div class="note" id="audioNote" hidden>Tip: if audio doesn’t start, click anywhere on the page first.</div>
    </div>
    <div id="paper" style="margin-top:16px"></div>
  </section>

  <section id="page-songs" class="tri-border section flag-cap hidden" role="region" aria-label="Songs & Lyrics">
    <h1>Songs & Lyrics</h1>
    <p>Tap a song to view full lyrics and background.</p>
    <div id="songlist" class="list"></div>
  </section>

  <section id="page-learn" class="tri-border section flag-cap hidden" role="region" aria-label="Learn">
    <h1>Learn Irish Music</h1>
    <p>Master the traditions, techniques, and culture of Irish music — without fear!</p>
    <div class="list">
      <div class="item"><strong>Notation</strong> — Understanding ABC</div>
      <div class="item"><strong>Instruments</strong> — Common instruments</div>
      <div class="item"><strong>Styles</strong> — Regional styles</div>
      <div class="item"><strong>Practice</strong> — How to practice</div>
    </div>
    <div class="tri-border section" style="margin-top:12px">
      <h2 style="margin-top:0">Understanding ABC Notation</h2>
<pre style="white-space:pre-wrap;line-height:1.45">X: Reference number
T: Title of the tune
R: Rhythm type (reel, jig, hornpipe)
M: Time signature (4/4, 6/8, etc.)
L: Default note length
K: Key signature
Notes are letters A–G (with sharps/flats). Uppercase = lower octave, lowercase = higher octave.
Numbers after notes show duration: A2 = half note, A4 = quarter note.</pre>
    </div>
  </section>

  <section id="page-tools" class="tri-border section flag-cap hidden" role="region" aria-label="Tools">
    <h1>Practice Tools</h1>
    <div class="list">
      <button class="item" id="mBtn" style="text-align:left"><strong>Metronome</strong> — Bouncing ball, 4/4 & 6/8</button>
      <button class="item" id="rBtn" style="text-align:left"><strong>Record Yourself</strong> — Mic recorder & playback</button>
      <button class="item" id="tuneBtn" style="text-align:left"><strong>Tuner</strong> — Nearest note & cents</button>
      <button class="item" id="studioBtn" style="text-align:left"><strong>ABC Studio</strong> — Paste ABC → render</button>
    </div>
    <div class="note">Mic features may require running from a local server (http://localhost) for permissions.</div>
    <div id="toolhost" class="toolhost" style="margin-top:12px"></div>
  </section>

  <div class="footerNote">© Gearóid MacUaid – Ceol Gan Eagla <span id="yy"></span></div>
</main>

<nav class="navbar" role="navigation">
  <a class="navbtn" id="nav-search" href="#search" aria-current="page">
    <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke-width="2"/></svg>
    <small>Search</small>
  </a>
  <a class="navbtn" id="nav-tunes" href="#tune">
    <svg viewBox="0 0 24 24" fill="none"><path d="M6 4v14a3 3 0 1 0 2-2.83V6h8v8a3 3 0 1 0 2-2.83V4z" stroke-width="2"/></svg>
    <small>Tunes</small>
  </a>
  <a class="navbtn" id="nav-songs" href="#songs">
    <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h10M4 18h7" stroke-width="2"/></svg>
    <small>Songs</small>
  </a>
  <a class="navbtn" id="nav-learn" href="#learn">
    <svg viewBox="0 0 24 24" fill="none"><path d="M4 10l8-4 8 4-8 4-8-4zM4 14l8 4 8-4" stroke-width="2"/></svg>
    <small>Learn</small>
  </a>
  <a class="navbtn" id="nav-tools" href="#tools">
    <svg viewBox="0 0 24 24" fill="none"><path d="M4 14l6-6M12 8l4 4M15 3l6 6-4 4-6-6V3h4z" stroke-width="2"/></svg>
    <small>Tools</small>
  </a>
</nav>

<!-- Primary ABCJS CDN -->
<script id="abcjs-cdn" src="https://cdn.jsdelivr.net/npm/abcjs@6.4.3/dist/abcjs-basic-min.js" onload="window._abcReady=true"></script>
<!-- Fallback: load from cdnjs if jsDelivr blocked -->
<script>
  window._abcReady = false;
  window.addEventListener('load', function(){
    setTimeout(function(){
      if(!window._abcReady || !window.ABCJS){
        var s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.4.3/abcjs-basic-min.min.js';
        s.onload=function(){ window._abcReady=true; initApp(); };
        document.body.appendChild(s);
        // show soft warning
        document.getElementById('abcErr').classList.remove('hidden');
      } else {
        initApp();
      }
    }, 50);
  });
</script>

<script>
function initApp(){
  document.getElementById('yy').textContent = new Date().getFullYear();

  // Router
  const pages={search:page_search,tune:page_tune,songs:page_songs,learn:page_learn,tools:page_tools};
  const navs={search:nav_search,tune:nav_tunes,songs:nav_songs,learn:nav_learn,tools:nav_tools};
  function route(name){ Object.values(pages).forEach(p=>p.classList.add('hidden')); Object.values(navs).forEach(n=>n.removeAttribute('aria-current')); (pages[name]||pages.search).classList.remove('hidden'); (navs[name]||navs.search).setAttribute('aria-current','page'); window.scrollTo({top:0,behavior:'instant'}); }
  function syncRoute(){ route((location.hash||'#search').slice(1)); }
  window.addEventListener('hashchange', syncRoute); syncRoute();

  // Data
  const TUNES=[
    {id:"roisin-dubh",title:"Róisín Dubh",type:"Air",level:"Beginner",source:"Traditional",summary:"A haunting slow air, “Dark Rosaleen.”",abc:`X:1
T:Róisín Dubh
R:air
M:3/4
L:1/8
K:Dmix
A2 | d2 c2 A2 | G2 A2 B2 | A2 F2 D2 | E4 A2 | d2 c2 A2 | G2 A2 B2 | A2 F2 D2 | E6 ||`},
    {id:"the-kesh-jig",title:"The Kesh",type:"Jig",level:"General",source:"Traditional",summary:"Session favourite jig in G.",abc:`X:1
T:The Kesh
R:jig
M:6/8
L:1/8
K:G
D|GFG BAB|gfg dBG|GFG BAB|dAG FGD|GFG BAB|gfg dBG|cAF GFE|DG F G3||`},
    {id:"the-silver-spear",title:"The Silver Spear",type:"Reel",level:"General",source:"Traditional",summary:"A well-known reel.",abc:`X:1
T:The Silver Spear
R:reel
M:4/4
L:1/8
K:D
A2 | d2 AD FA dA | d2 AD FA dA | g2 fg edef | g2 fg edB A | d2 AD FA dA | d2 AD FA dA | g2 fg edef | g2 fg e2 d2 ||`}
  ];
  const SONGS=[{id:"oro-se-do",title:"Óró Sé Do Bheatha Abhaile",tags:["traditional song","Irish","General"],blurb:"A welcoming song associated with Gráinne Mhaol.",lyrics:`Óró, sé do bheatha ‘bhaile,
Óró, sé do bheatha ‘bhaile,
Óró, sé do bheatha ‘bhaile,
Anois ar theacht an tsamhraidh.`}];

  // Search & Filters
  const q=document.getElementById('q');
  const pillsScope=[...document.querySelectorAll('#scopePills .pill')];
  const pillsKind=[...document.querySelectorAll('#kindPills .pill')];
  let scope='all', kind='All Types';
  function setPressed(group, el){ group.forEach(b=>b.setAttribute('aria-pressed','false')); el.setAttribute('aria-pressed','true'); }
  pillsScope.forEach(b=>b.addEventListener('click',()=>{ scope=b.dataset.scope; setPressed(pillsScope,b); renderSearch(); }));
  pillsKind.forEach(b=>b.addEventListener('click',()=>{ kind=b.dataset.kind; setPressed(pillsKind,b); renderSearch(); }));
  q.addEventListener('input', renderSearch);

  function match(text, term){ return text.toLowerCase().includes(term.toLowerCase()); }
  function renderSearch(){
    const term = q.value?.trim() || ''; const list = document.getElementById('results'); let items = [];
    if(scope==='all' || scope==='tunes'){
      items = items.concat(TUNES.filter(t =>
        (kind==='All Types' || t.type===kind) &&
        (!term || match(t.title,term) || match(t.summary,term) || match(t.type,term))
      ).map(t => ({ kind:'tune', id:t.id, title:t.title, meta:[t.type, t.level, t.source], blurb:t.summary })));
    }
    if(scope==='all' || scope==='songs'){
      items = items.concat(SONGS.filter(s => !term || match(s.title,term) || match(s.blurb,term))
        .map(s => ({ kind:'song', id:s.id, title:s.title, meta:s.tags, blurb:s.blurb })));
    }
    list.innerHTML = items.map(it => `
      <a class="item" href="#${it.kind==='tune'?'tune':'songs'}" data-kind="${it.kind}" data-id="${it.id}">
        <h3 style="margin:0">${it.title}</h3>
        <div class="badges">${it.meta.map(m=>`<span class="badge">${m}</span>`).join('')}</div>
        <div style="color:var(--muted)">${it.blurb||''}</div>
      </a>`).join('') || '<div style="padding:14px;color:#6b7d72">No results.</div>';
    [...list.querySelectorAll('a.item')].forEach(a=>a.addEventListener('click', (e)=>{
      const kind=a.getAttribute('data-kind'), id=a.getAttribute('data-id'); openItem(kind,id);
    }));
  }
  renderSearch();

  // Tune View
  const tTitle = document.getElementById('t-title');
  const tBadges = document.getElementById('t-badges');
  const tBlurb = document.getElementById('t-blurb');
  const paper = document.getElementById('paper');
  const audioNote = document.getElementById('audioNote');
  let currentTune, synthControl, visualObj;

  function openItem(kind, id){
    if(kind==='tune'){
      currentTune = TUNES.find(x=>x.id===id) || TUNES[0];
      tTitle.textContent = currentTune.title;
      tBlurb.textContent = currentTune.summary || '';
      tBadges.innerHTML = [`<span class="badge air">${currentTune.type}</span>`,`<span class="badge">${currentTune.level}</span>`,`<span class="badge">${currentTune.source}</span>`].join('');
      paper.innerHTML = '';
      try{
        visualObj = ABCJS.renderAbc('paper', currentTune.abc, { responsive:'resize', add_classes:true })[0];
      }catch(err){
        paper.innerHTML = `<div class="note">ABCJS render error: ${err.message}</div>`;
      }
      location.hash = 'tune';
    } else {
      renderSongs(); location.hash = 'songs'; setTimeout(()=>{ const el=document.getElementById(id); if(el) el.open=true; }, 60);
    }
  }

  document.getElementById('t-play').addEventListener('click', async () => {
    if (!window.ABCJS || !ABCJS.synth || !visualObj) return;
    audioNote.hidden = false;
    try{
      const synth = new ABCJS.synth.CreateSynth();
      await synth.init({ visualObj });
      const control = new ABCJS.synth.SynthController();
      const target = document.createElement('div'); target.style.margin = '10px 0'; paper.prepend(target);
      control.load(target, null, { displayLoop:false, displayRestart:false, displayPlay:false, displayProgress:true });
      await synth.prime();
      control.setTune(visualObj, false);
      control.play();
      synthControl = control;
    }catch(err){
      paper.insertAdjacentHTML('afterbegin', `<div class="note">Audio init failed: ${err.message}</div>`);
    }
  });
  document.getElementById('t-stop').addEventListener('click', ()=> synthControl && synthControl.pause());
  document.getElementById('t-print').addEventListener('click', ()=> window.print());

  // Songs
  function renderSongs(){
    const list = document.getElementById('songlist');
    list.innerHTML = SONGS.map(s => `
      <details class="item" id="${s.id}">
        <summary style="cursor:pointer"><strong>${s.title}</strong>
          <div class="badges" style="margin-top:6px">${s.tags.map(t=>`<span class="badge">${t}</span>`).join('')}</div>
        </summary>
        <div style="white-space:pre-wrap;margin-top:8px">${s.lyrics}</div>
      </details>`).join('');
  }
  renderSongs();

  // Tools (inline)
  const host = document.getElementById('toolhost');
  document.getElementById('studioBtn').addEventListener('click', studio);
  document.getElementById('mBtn').addEventListener('click', metronome);
  document.getElementById('rBtn').addEventListener('click', recorder);
  document.getElementById('tuneBtn').addEventListener('click', tuner);

  function studio(){
    host.innerHTML = `<h3 style="margin-top:0">ABC Studio</h3>
    <textarea id="abcsrc" style="width:100%;height:160px">X:1
T:New Tune
R:jig
M:6/8
L:1/8
K:G
D|GFG BAB|gfg dBG|</textarea>
    <div class="actions"><button class="btn play" id="renderBtn">Render</button>
    <button class="btn pdf" id="printBtn">Print / PDF</button></div>
    <div id="studioPaper" style="margin-top:10px"></div>`;
    document.getElementById('renderBtn').addEventListener('click', ()=>{
      try{ ABCJS.renderAbc('studioPaper', document.getElementById('abcsrc').value, { responsive:'resize' }); }
      catch(err){ document.getElementById('studioPaper').innerHTML = `<div class="note">ABCJS render error: ${err.message}</div>`; }
    });
    document.getElementById('printBtn').addEventListener('click', ()=>window.print());
  }

  function metronome(){
    host.innerHTML = `<h3 style="margin-top:0">Metronome</h3>
    <div style="display:flex;gap:10px;align-items:center;margin:8px 0">
      <label>BPM <input id="bpm" type="number" value="96" min="30" max="220" style="width:80px"></label>
      <label>Time <select id="sig"><option>4/4</option><option selected>6/8</option></select></label>
      <button id="mToggle" class="btn play">Start</button>
    </div>
    <canvas id="rail" width="700" height="140" style="width:100%;background:#fff;border:1px solid var(--line);border-radius:14px"></canvas>`;
    const ctx = document.getElementById('rail').getContext('2d');
    const bpm = document.getElementById('bpm'); const sig = document.getElementById('sig'); const toggle = document.getElementById('mToggle');
    let audioCtx, running=false, last=0, beat=0;
    function setup(){ audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); }
    function draw(progress,beats){
      const w=ctx.canvas.width,h=ctx.canvas.height; ctx.clearRect(0,0,w,h);
      const pad=30,usable=w-2*pad; ctx.strokeStyle='#cfe6d6'; ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(pad,h/2); ctx.lineTo(w-pad,h/2); ctx.stroke();
      for(let i=0;i<beats;i++){ const x=pad+usable*(i/(beats-1||1)); ctx.fillStyle=i===0?'#1d7f3b':'#9fbda8'; ctx.beginPath(); ctx.arc(x,h/2,8,0,6.28); ctx.fill(); }
      const x=pad+usable*progress; ctx.fillStyle='#1d7f3b'; ctx.beginPath(); ctx.arc(x,h/2,18,0,6.28); ctx.fill();
    }
    function beats(){ return sig.value==='6/8'?6:4; }
    function tickSound(accent=false){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(), t=audioCtx.currentTime; o.type='square'; o.frequency.value=accent?1760:880; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.4,t+0.005); g.gain.exponentialRampToValueAtTime(0.001,t+0.08); o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+0.09); }
    function loop(t){ if(!running) return; if(!last) last=t; const spb=60/Number(bpm.value); const elapsed=(t-last)/1000; if(elapsed>=spb){ last=t; tickSound(beat%beats()===0); beat=(beat+1)%beats(); } const prog=Math.min(elapsed/(60/Number(bpm.value)),1); draw(prog,beats()); requestAnimationFrame(loop); }
    toggle.addEventListener('click', ()=>{ running=!running; toggle.textContent=running?'Stop':'Start'; toggle.className=running?'btn':'btn play'; if(running){ setup(); last=0; beat=0; requestAnimationFrame(loop);} });
  }

  function recorder(){
    host.innerHTML = `<h3 style="margin-top:0">Record Yourself</h3>
      <div class="actions"><button id="rStart" class="btn play">● Start</button><button id="rStop" class="btn">■ Stop</button>
      <a id="rDL" class="btn pdf" href="#" download="take.webm" style="pointer-events:none;opacity:.6">Download</a></div>
      <div class="note">If the mic button doesn’t work, run from a local server (http://localhost) to enable permissions.</div>
      <audio id="rPlayer" controls style="width:100%;margin-top:10px"></audio>
      <div id="rLog" style="margin-top:6px;color:var(--muted)"></div>`;
    const start = document.getElementById('rStart'), stop = document.getElementById('rStop'), player = document.getElementById('rPlayer'), dl = document.getElementById('rDL'), log = document.getElementById('rLog');
    let media, rec, chunks=[];
    start.addEventListener('click', async ()=>{
      try{
        media = await navigator.mediaDevices.getUserMedia({audio:true});
        rec = new MediaRecorder(media); chunks=[];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => { const blob=new Blob(chunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob); player.src=url; dl.href=url; dl.style.opacity=1; dl.style.pointerEvents='auto'; };
        rec.start(); log.textContent='Recording…';
      }catch(e){ log.textContent='Mic error: '+e.message; }
    });
    stop.addEventListener('click', ()=>{ if(rec && rec.state!=='inactive'){ rec.stop(); log.textContent='Stopped.'; if(media){ media.getTracks().forEach(t=>t.stop()); } } });
  }

  function tuner(){
    host.innerHTML = `<h3 style="margin-top:0">Tuner</h3>
      <div class="actions"><button id="tStart" class="btn play">Start Mic</button><button id="tStop" class="btn">Stop</button></div>
      <div class="note">Mic access requires running from http://localhost in some browsers.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div class="tri-border section"><div style="font-size:48px;font-weight:900" id="nNote">--</div><div id="nFreq" style="color:var(--muted)">0 Hz</div></div>
        <div class="tri-border section"><div>Detune (cents)</div><div id="nCents" style="font-size:36px;font-weight:800">0</div></div>
      </div>`;
    const nNote = document.getElementById('nNote'), nFreq = document.getElementById('nFreq'), nCents = document.getElementById('nCents');
    let ctx, media, src, analyser, raf;
    function autoCorrelate(buf, sr){
      let SIZE=buf.length; let rms=0; for(let i=0;i<SIZE;i++){ let v=buf[i]; rms+=v*v; } rms=Math.sqrt(rms/SIZE); if(rms<0.01) return -1;
      let c=new Array(SIZE).fill(0); for(let i=0;i<SIZE;i++) for(let j=0;j<SIZE-i;j++) c[i]+=buf[j]*buf[j+i];
      let d=0; while(c[d]>c[d+1]) d++; let maxval=-1,maxpos=-1; for(let i=d;i<SIZE;i++){ if(c[i]>maxval){ maxval=c[i]; maxpos=i; } } return sr/maxpos;
    }
    const A4=440, names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    function nf(freq){ return Math.round(12*Math.log2(freq/A4))+69; }
    function fFrom(n){ return A4*Math.pow(2,(n-69)/12); }
    function cents(freq,n){ return Math.floor(1200*Math.log2(freq/fFrom(n))); }
    document.getElementById('tStart').addEventListener('click', async ()=>{
      try{
        ctx = ctx || new (window.AudioContext||window.webkitAudioContext)();
        media = await navigator.mediaDevices.getUserMedia({audio:true});
        src = ctx.createMediaStreamSource(media); analyser=ctx.createAnalyser(); analyser.fftSize=2048; src.connect(analyser); tick();
      }catch(e){ nFreq.textContent = 'Mic error: '+e.message; }
    });
    document.getElementById('tStop').addEventListener('click', ()=>{ cancelAnimationFrame(raf); if(media){ media.getTracks().forEach(t=>t.stop()); } });
    function tick(){ raf=requestAnimationFrame(tick); let data=new Float32Array(analyser.fftSize); analyser.getFloatTimeDomainData(data); const f=autoCorrelate(data, ctx.sampleRate); if(f>0){ const n=nf(f); nNote.textContent=names[n%12]+(Math.floor(n/12)-1); nFreq.textContent=f.toFixed(1)+' Hz'; nCents.textContent=cents(f,n); } }
  }

  // Default tool for demo
  studio();
}
</script>
</body>
</html>